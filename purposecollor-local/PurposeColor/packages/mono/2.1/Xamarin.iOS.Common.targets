<!--
***********************************************************************************************
Xamarin.iOS.Common.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
  created a backup copy.  Incorrect changes to this file will make it
  impossible to load or build your projects from the command-line or the IDE.

This file imports the version- and platform-specific targets for the project importing
this file. This file also defines targets to produce an error if the specified targets
file does not exist, but the project is built anyway (command-line or IDE build).

Copyright (C) 2013-2014 Xamarin. All rights reserved.
***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<UsingTask TaskName="Xamarin.MacDev.Tasks.ArTool" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.Codesign" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.CollectBundleResources" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.ComputeBundleResourceOutputPaths" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.CreateAssetPackManifest" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.CreatePkgInfo" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.Ditto" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.DSymUtil" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.FindItemWithLogicalName" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.GenerateBundleName" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.GetNativeExecutableName" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.GetPropertyListValue" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.Move" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.PackLibraryResources" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.SmartCopy" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.SpotlightIndexer" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.SymbolStrip" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.UnpackLibraryResources" AssemblyFile="Xamarin.MacDev.Tasks.dll" />
	<UsingTask TaskName="Xamarin.MacDev.Tasks.Zip" AssemblyFile="Xamarin.MacDev.Tasks.dll" />

	<UsingTask TaskName="Xamarin.iOS.Tasks.ACTool" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.Archive" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CodesignVerify" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CollectFrameworks" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CollectITunesArtwork" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CollectITunesSourceFiles" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CompileAppManifest" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CompileEntitlements" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CompileITunesMetadata" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CompileSceneKitAssets" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CreateDebugSettings" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.CreateDebugConfiguration" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.DetectBundleIdentifier" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.DetectSdkLocations" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.DetectSigningIdentity" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.EmbedMobileProvision" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.FindWatchAppBundle" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.IBTool" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.MetalLib" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.Metal" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.MTouch" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.OptimizeImage" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.OptimizePropertyList" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.ParseDeviceSpecificBuildInformation" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.ParseExtraMtouchArgs" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.PrepareResourceRules" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.ScnTool" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.TextureAtlas" AssemblyFile="Xamarin.iOS.Tasks.dll" />
	<UsingTask TaskName="Xamarin.iOS.Tasks.ValidateAppBundleTask" AssemblyFile="Xamarin.iOS.Tasks.dll" />

	<UsingTask TaskName="Microsoft.Build.Tasks.Copy" AssemblyFile="Xamarin.iOS.Tasks.dll"/>
	<UsingTask TaskName="Microsoft.Build.Tasks.MakeDir" AssemblyFile="Xamarin.iOS.Tasks.dll"/>
	<UsingTask TaskName="Microsoft.Build.Tasks.RemoveDir" AssemblyFile="Xamarin.iOS.Tasks.dll"/>
	<UsingTask TaskName="Microsoft.Build.Tasks.Delete" AssemblyFile="Xamarin.iOS.Tasks.dll"/>
	<UsingTask TaskName="Microsoft.Build.Tasks.Touch" AssemblyFile="Xamarin.iOS.Tasks.dll"/>

	<Import Project="$(MSBuildThisFileDirectory)Xamarin.iOS.Common.props" 
			Condition="'$(_XamarinCommonPropsHasBeenImported)' != 'true'" />

	<Import Project="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).Before.targets" 
			Condition="Exists('$(MSBuildThisFileDirectory)$(MSBuildThisFileName).Before.targets')"/>

	<PropertyGroup>
		<!-- Switching to a new property allows us to potentially switch from iPhone to simulator builds
			 dynamically based on the user's selection when starting the project. This allows us to 
			 eventually even (optionally) switch back to AnyCPU platform in the IDE, therefore 
			 fixing a key pain point in managing solution configurations. -->
		<ComputedPlatform Condition="'$(ComputedPlatform)' == ''">$(Platform)</ComputedPlatform>
		<ComputedPlatform Condition="'$(ComputedPlatform)' == 'AnyCPU'">iPhone</ComputedPlatform>

		<_CanOutputAppBundle>False</_CanOutputAppBundle>
		<_CanOutputAppBundle Condition="'$(OutputType)' == 'Exe' Or '$(IsAppExtension)' == 'true' Or '$(IsWatchApp)' == 'true'">True</_CanOutputAppBundle>

		<_CanArchive>False</_CanArchive>
		<_CanArchive Condition="'$(OutputType)' == 'Exe' And '$(ComputedPlatform)' == 'iPhone' And '$(IsAppExtension)' == 'false' And '$(IsWatchApp)' == 'false'">True</_CanArchive>

		<_PreparedResourceRules></_PreparedResourceRules>
		<_AppBundleName>$(AssemblyName)</_AppBundleName>
	</PropertyGroup>
	
	<PropertyGroup>
		<ImplicitlyExpandDesignTimeFacades>true</ImplicitlyExpandDesignTimeFacades>
		<CheckForSystemRuntimeDependency>true</CheckForSystemRuntimeDependency>

		<ResolveReferencesDependsOn>
			_SeparateAppExtensionReferences;
			_SeparateWatchAppReferences;
			$(ResolveReferencesDependsOn);
			ImplicitlyExpandDesignTimeFacades
		</ResolveReferencesDependsOn>

		<ImplicitlyExpandDesignTimeFacadesDependsOn>
			$(ImplicitlyExpandDesignTimeFacadesDependsOn);
			GetReferenceAssemblyPaths
		</ImplicitlyExpandDesignTimeFacadesDependsOn>
	</PropertyGroup>

	<Target Name="ImplicitlyExpandDesignTimeFacades" Condition="'$(ImplicitlyExpandDesignTimeFacades)' == 'true'" DependsOnTargets="$(ImplicitlyExpandDesignTimeFacadesDependsOn)">
		<PropertyGroup>
			<_HasReferenceToSystemRuntime Condition="'$(DependsOnSystemRuntime)' == 'true' or '%(_ResolvedProjectReferencePaths.TargetPlatformIdentifier)' == 'Portable' 
								or '%(ReferenceDependencyPaths.Filename)' == 'System.Runtime'">true</_HasReferenceToSystemRuntime>
		</PropertyGroup>

		<ItemGroup Condition="'$(_HasReferenceToSystemRuntime)' == 'true'">
			<_DesignTimeFacadeAssemblies Include="%(DesignTimeFacadeDirectories.Identity)*.dll"/>
			<ReferencePath Remove="@(_DesignTimeFacadeAssemblies)"/>
			<ReferencePath Include="%(_DesignTimeFacadeAssemblies.Identity)">
				<WinMDFile>false</WinMDFile>
				<CopyLocal>false</CopyLocal>
				<ResolvedFrom>ImplicitlyExpandDesignTimeFacades</ResolvedFrom>
			</ReferencePath>
			<ReferenceDependencyPath Include="@(ReferencePath)" Condition="'%(ReferencePath.ResolvedFrom)' == 'ImplicitlyExpandDesignTimeFacades'" />
		</ItemGroup>

		<Message Importance="Low" Text="Including @(ReferencePath)" Condition="'%(ReferencePath.ResolvedFrom)' == 'ImplicitlyExpandDesignTimeFacades'" />
	</Target>

	<Target Name="_ComputeTargetArchitectures">
		<PropertyGroup>
			<DeviceSpecificIntermediateOutputPath>$(IntermediateOutputPath)</DeviceSpecificIntermediateOutputPath>
			<DeviceSpecificOutputPath>$(OutputPath)</DeviceSpecificOutputPath>
		</PropertyGroup>

		<ParseDeviceSpecificBuildInformation
			SessionId="$(BuildSessionId)"
			Condition="'$(DeviceSpecificBuild)' == 'true' And '$(TargetiOSDevice)' != '' And '$(_CanOutputAppBundle)' == 'true'"
			Architectures="$(MtouchArch)"
			IntermediateOutputPath="$(IntermediateOutputPath)"
			OutputPath="$(OutputPath)"
			TargetiOSDevice="$(TargetiOSDevice)"
		>
			<Output TaskParameter="DeviceSpecificIntermediateOutputPath" PropertyName="DeviceSpecificIntermediateOutputPath" />
			<Output TaskParameter="DeviceSpecificOutputPath" PropertyName="DeviceSpecificOutputPath" />
			<Output TaskParameter="TargetArchitectures" PropertyName="TargetArchitectures" />
			<Output TaskParameter="TargetDeviceModel" PropertyName="TargetDeviceModel" />
			<Output TaskParameter="TargetDeviceOSVersion" PropertyName="TargeDeviceOSVersion" />
		</ParseDeviceSpecificBuildInformation>

		<PropertyGroup>
			<_MtouchSymbolsList>$(DeviceSpecificIntermediateOutputPath)mtouch-symbols.list</_MtouchSymbolsList>
		</PropertyGroup>
	</Target>

	<!-- Insert our app bundle generation step -->
	<PropertyGroup>
		<BuildDependsOn>
			BuildOnlySettings;
			PrepareForBuild;
			_CollectBundleResources;
			_OptimizePngImages;
			_OptimizePropertyLists;
			_OptimizeLocalizationFiles;
			_PackLibraryResources;
			_UnpackLibraryResources;
			$(BuildDependsOn);
			_CleanUploaded;
			_CreateAppBundle;
			Codesign;
			CreateIpa;
			Archive;
		</BuildDependsOn>

		<CleanDependsOn>
			$(CleanDependsOn);
			_CleanUploaded;
			_CleanAppBundle;
			_CleanDebugSymbols;
			_CleanITunesArtwork;
			_CleanDeviceSpecificOutput;
			_CleanIntermediateToolOutput;
		</CleanDependsOn>
	</PropertyGroup>

	<PropertyGroup>
		<CompileColladaAssetsDependsOn>
			_CollectColladaAssets;
			_CoreCompileColladaAssets
		</CompileColladaAssetsDependsOn>
	</PropertyGroup>

	<PropertyGroup>
		<_IsContainerApp>false</_IsContainerApp>
		<_IsContainerApp Condition="$(IsAppExtension) == 'false' And '$(IsWatchApp)' == 'false'">true</_IsContainerApp>
	</PropertyGroup>

	<Target Name="_CompileColladaAssets" Condition="'$(_CanOutputAppBundle)' == 'true'" DependsOnTargets="$(CompileColladaAssetsDependsOn)" />

	<PropertyGroup>
		<OptimizePngImagesDependsOn>
			_CollectPngImages;
			_CoreOptimizePngImages;
			_AfterCoreOptimizePngImages
		</OptimizePngImagesDependsOn>
	</PropertyGroup>

	<Target Name="_OptimizePngImages" DependsOnTargets="$(OptimizePngImagesDependsOn)" />

	<PropertyGroup>
		<OptimizePropertyListsDependsOn>
			_CollectPropertyLists;
			_CoreOptimizePropertyLists;
			_AfterCoreOptimizePropertyLists
		</OptimizePropertyListsDependsOn>
	</PropertyGroup>

	<Target Name="_OptimizePropertyLists" DependsOnTargets="$(OptimizePropertyListsDependsOn)" />

	<PropertyGroup>
		<OptimizeLocalizationFilesDependsOn>
			_CollectLocalizationFiles;
			_CoreOptimizeLocalizationFiles;
			_AfterCoreOptimizeLocalizationFiles
		</OptimizeLocalizationFilesDependsOn>
	</PropertyGroup>

	<Target Name="_OptimizeLocalizationFiles" DependsOnTargets="$(OptimizeLocalizationFilesDependsOn)" />

	<PropertyGroup>
		<CreateAppBundleDependsOn>
			_CleanUploaded;
			_DetectAppManifest;
			_DetectSigningIdentity;
			_GenerateBundleName;
			_CopyResourcesToBundle;
			_CreateAssetPackManifest;
			_SmeltMetal;
			_ForgeMetal;
			_TemperMetal;
			_PrepareResourceRules;
			_CompileEntitlements;
			_CompileAppManifest;
			_GetNativeExecutableName;
			_CompileToNative;
			_CompileITunesMetadata;
			_CollectITunesArtwork;
			_CopyITunesArtwork;
			_CreateDebugSettings;
			_CreateDebugConfiguration;
			_CreatePkgInfo;
			_CopyAppExtensionsToBundle;
			_CopyWatchAppsToBundle;
			_CopyWatch2AppsToBundle;
			_GenerateDebugSymbols;
			_ValidateAppBundle;
		</CreateAppBundleDependsOn>
	</PropertyGroup>

	<Target Name="_CreateAppBundle" Condition="'$(_CanOutputAppBundle)' == 'true'" DependsOnTargets="$(CreateAppBundleDependsOn)" />

	<PropertyGroup>
		<_CodesignAppBundleDependsOn>
			_EmbedMobileProvision;
			_CodesignNativeLibraries;
			_CodesignFrameworks;
		</_CodesignAppBundleDependsOn>

		<_CoreCodesignDependsOn>
			_CodesignAppBundle;
			_CodesignVerify;
		</_CoreCodesignDependsOn>

		<CodesignDependsOn>
			BeforeCodeSign;
			CoreCodeSign;
			AfterCodeSign;
		</CodesignDependsOn>
	</PropertyGroup>

	<Target Name="BeforeCodesign" />
	<Target Name="CoreCodesign" DependsOnTargets="$(_CoreCodesignDependsOn)" />
	<Target Name="AfterCodesign" />

	<Target Name="Codesign" Condition="'$(_CanOutputAppBundle)' == 'true' And '$(ComputedPlatform)' == 'iPhone'"  DependsOnTargets="_CreateAppBundle;$(CodesignDependsOn)" />

	<PropertyGroup>
		<CreateIpaDependsOn>
			_CoreCreateIpa
		</CreateIpaDependsOn>

		<ArchiveDependsOn>
			_CoreArchive
		</ArchiveDependsOn>
	</PropertyGroup>

	<Target Name="Archive" Condition="'$(_CanArchive)' == 'true'" DependsOnTargets="$(ArchiveDependsOn)" />

	<Target Name="CreateIpa" Condition="'$(_CanArchive)' == 'true'" DependsOnTargets="$(CreateIpaDependsOn)" />

	<Target Name="_CleanAppBundle" Condition="'$(_CanOutputAppBundle)' == 'true'" DependsOnTargets="_GenerateBundleName">
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(_AppBundlePath)" />
	</Target>

	<Target Name="_CleanUploaded" Condition="'$(_CanOutputAppBundle)' == 'true'" DependsOnTargets="_GenerateBundleName">
		<Delete SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Files="$(DeviceSpecificOutputPath).uploaded" />
	</Target>

	<Target Name="_CleanDebugSymbols" Condition="'$(_CanOutputAppBundle)' == 'true'" DependsOnTargets="_GenerateBundleName">
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(AppBundleDir).dSYM" />
		<Delete SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Files="$(OutputPath)*.bcsymbolmap" />
	</Target>

	<Target Name="_CleanITunesArtwork" Condition="'$(_CanArchive)' == 'true'">
		<Delete SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Files="$(OutputPath)iTunesMetadata.plist;$(OutputPath)iTunesArtwork@2x;$(OutputPath)iTunesArtwork" />
	</Target>

	<Target Name="_CleanDeviceSpecificOutput" Condition="'$(_CanOutputAppBundle)' == 'true'">
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)build-*" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(OutputPath)build-*" />
	</Target>

	<Target Name="_CleanIntermediateToolOutput">
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)actool" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)assetpacks" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)ibtool" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)ibtool-manifests" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)ipa" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)metal" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)optimized" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)scntool" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)TextureAtlas" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)mtouch-cache" />
		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)" />
	</Target>

	<PropertyGroup>
		<_CollectBundleResourcesDependsOn>
			_CompileInterfaceDefinitions;
			_CompileImageAssets;
			_CompileColladaAssets;
			_CompileSceneKitAssets;
			_CompileTextureAtlases;
		</_CollectBundleResourcesDependsOn>
	</PropertyGroup>

	<!-- TODO: check for duplicate items -->
	<Target Name="_ComputeBundleResourceOutputPaths" DependsOnTargets="_CollectBundleResources;_GenerateBundleName;_DetectSigningIdentity">
		<ComputeBundleResourceOutputPaths
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleDir="$(AppBundleDir)"
			BundleIdentifier="$(_BundleIdentifier)"
			BundleResources="@(_BundleResourceWithLogicalName)"
			IntermediateOutputPath="$(IntermediateOutputPath)"
			OutputPath="$(OutputPath)"
		>
			<Output TaskParameter="BundleResourcesWithOutputPaths" ItemName="_BundleResourceWithOutputPath"/>
		</ComputeBundleResourceOutputPaths>
	</Target>

	<Target Name="_CopyResourcesToBundle" DependsOnTargets="_ComputeBundleResourceOutputPaths"
		Inputs = "@(_BundleResourceWithOutputPath)"
		Outputs = "@(_BundleResourceWithOutputPath -> '%(OutputPath)')" >
		<SmartCopy
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			SourceFiles = "@(_BundleResourceWithOutputPath)"
			DestinationFiles = "@(_BundleResourceWithOutputPath -> '%(OutputPath)')"
		/>
	</Target>

	<Target Name="_CreateAssetPackManifest" DependsOnTargets="_CopyResourcesToBundle">
		<CreateAssetPackManifest
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleDir="$(AppBundleDir)"
			OutputPath="$(OutputPath)"
		/>
	</Target>

	<Target Name="_CollectBundleResources" DependsOnTargets="$(_CollectBundleResourcesDependsOn)">
		<CollectBundleResources
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			OptimizePropertyLists="$(OptimizePropertyLists)"
			OptimizePNGs="$(OptimizePNGs)"
			BundleResources="@(Content);@(BundleResource)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)"
			>

			<Output TaskParameter="BundleResourcesWithLogicalNames" ItemName="_BundleResourceWithLogicalName"/>
		</CollectBundleResources>
	</Target>

	<Target Name="_DetectAppManifest" Condition="'$(_CanOutputAppBundle)' == 'true'" >
		<FindItemWithLogicalName
			SessionId="$(BuildSessionId)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)"
			LogicalName="Info.plist"
			Items="@(None)">
			<Output TaskParameter="Item" PropertyName="_AppManifest" />
		</FindItemWithLogicalName>
		<FindItemWithLogicalName Condition="'$(_AppManifest)' == ''"
			SessionId="$(BuildSessionId)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)"
			LogicalName="Info.plist"
			Items="@(BundleResource)">
			<Output TaskParameter="Item" PropertyName="_AppManifest" />
		</FindItemWithLogicalName>
		<FindItemWithLogicalName Condition="'$(_AppManifest)' == ''"
			SessionId="$(BuildSessionId)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)"
			LogicalName="Info.plist"
			Items="@(Content)">
			<Output TaskParameter="Item" PropertyName="_AppManifest" />
		</FindItemWithLogicalName>
		<Error Condition="'$(_AppManifest)' == ''" Text="Info.plist not found."/>
	</Target>

	<Target Name="_SmeltMetal" Condition="'$(_CanOutputAppBundle)' == 'true' And '@(Metal)' != ''" DependsOnTargets="_DetectSdkLocations">
		<Error Condition="'$(ComputedPlatform)' == 'iPhoneSimulator'" Text="The iOS Simulator does not support metal. Build for a device instead."/>

		<Metal
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			IntermediateOutputPath="$(IntermediateOutputPath)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)"
			SdkDevPath="$(_SdkDevPath)"
			SourceFile="%(Metal.Identity)">
			<Output TaskParameter="OutputFile" ItemName="_SmeltedMetal" />
		</Metal>
	</Target>

	<Target Name="_ForgeMetal" Condition="'$(_CanOutputAppBundle)' == 'true' And '@(_SmeltedMetal)' != ''" DependsOnTargets="_SmeltMetal"
		Inputs="@(_SmeltedMetal)" Outputs="$(IntermediateOutputPath)metal\default.metal-ar">
		<ArTool
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			Items="@(_SmeltedMetal)"
			Archive="$(IntermediateOutputPath)metal\default.metal-ar">
		</ArTool>

		<CreateItem Include="$(IntermediateOutputPath)metal\default.metal-ar">
			<Output TaskParameter="Include" ItemName="_ForgedMetal" />
		</CreateItem>
	</Target>

	<Target Name="_TemperMetal" Condition="'$(_CanOutputAppBundle)' == 'true' And '@(_ForgedMetal)' != ''" DependsOnTargets="_ForgeMetal"
		Inputs="@(_ForgedMetal)" Outputs="$(_AppBundlePath)default.metallib">
		<MetalLib
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			Items="@(_ForgedMetal)"
			SdkDevPath="$(_SdkDevPath)"
			OutputLibrary="$(_AppBundlePath)default.metallib">
		</MetalLib>

		<CreateItem Include="$(_AppBundlePath)default.metallib">
			<Output TaskParameter="Include" ItemName="_NativeLibrary" />
		</CreateItem>
	</Target>

	<Target Name="_PackLibraryResources" Condition="'$(_CanOutputAppBundle)' == 'false'" DependsOnTargets="_CollectBundleResources">
		<PackLibraryResources
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			Prefix="monotouch"
			BundleResourcesWithLogicalNames="@(_BundleResourceWithLogicalName)">
			<Output TaskParameter="EmbeddedResources" ItemName="EmbeddedResource" />
		</PackLibraryResources>
	</Target>

	<Target Name="_UnpackLibraryResources" Condition="'$(_CanOutputAppBundle)' == 'true'" DependsOnTargets="ResolveReferences;_CollectBundleResources">
		<UnpackLibraryResources
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			Prefix="monotouch"
			NoOverwrite="@(_BundleResourceWithLogicalName)"
			IntermediateOutputPath="$(IntermediateOutputPath)"
			ReferencedLibraries="@(ReferencePath);@(ReferenceDependencyPaths)">
			<Output TaskParameter="BundleResourcesWithLogicalNames" ItemName="_BundleResourceWithLogicalName" />
			<Output TaskParameter="BundleResourcesWithLogicalNames" ItemName="FileWrites" />
		</UnpackLibraryResources>
	</Target>

	<Target Name="_DetectSdkLocations" DependsOnTargets="_ComputeTargetArchitectures">
		<DetectSdkLocations
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			SdkVersion="$(MtouchSdkVersion)"
			TargetFrameworkIdentifier="$(TargetFrameworkIdentifier)"
			TargetArchitectures="$(TargetArchitectures)"
			>
			
			<Output TaskParameter="SdkVersion" PropertyName="MtouchSdkVersion" />
			<Output TaskParameter="SdkRoot" PropertyName="_SdkRoot" />
			<Output TaskParameter="SdkBinPath" PropertyName="_SdkBinPath" />
			<Output TaskParameter="SdkDevPath" PropertyName="_SdkDevPath" />
			<Output TaskParameter="SdkUsrPath" PropertyName="_SdkUsrPath" />
			<Output TaskParameter="SdkPlatform" PropertyName="_SdkPlatform" />
			<Output TaskParameter="SdkIsSimulator" PropertyName="_SdkIsSimulator" />
		</DetectSdkLocations>
	</Target>

	<Target Name="_DetectSigningIdentity" DependsOnTargets="_DetectAppManifest;_DetectSdkLocations" Condition="'$(_CanOutputAppBundle)' == 'true'">
		<PropertyGroup>
			<_RequireCodeSigning>false</_RequireCodeSigning>
			<_RequireCodeSigning Condition="'$(ComputedPlatform)' == 'iPhone' Or '$(CodesignEntitlements)' != ''">true</_RequireCodeSigning>
		</PropertyGroup>

		<DetectSigningIdentity
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleName="$(_AppBundleName)"
			AppManifest="$(_AppManifest)"
			RequireCodeSigning="$(_RequireCodeSigning)"
			SdkIsSimulator="$(_SdkIsSimulator)"
			SdkPlatform="$(_SdkPlatform)"
			ProvisioningProfile="$(CodesignProvision)"
			SigningKey="$(CodesignKey)"
			>

			<Output TaskParameter="DetectedAppId" PropertyName="_AppIdentifier" />
			<Output TaskParameter="DetectedBundleId" PropertyName="_BundleIdentifier" />
			<Output TaskParameter="DetectedBundleVersion" PropertyName="_BundleVersion" />
			<Output TaskParameter="DetectedCodeSigningKey" PropertyName="_CodeSigningKey" />
			<Output TaskParameter="DetectedCodesignAllocate" PropertyName="_CodesignAllocate" />
			<Output TaskParameter="DetectedProvisioningProfile" PropertyName="_ProvisioningProfile" />
		</DetectSigningIdentity>
	</Target>
	
	<Target Name="_GenerateBundleName" DependsOnTargets="_ComputeTargetArchitectures">
		<PropertyGroup>
			<AppBundleDir>$(DeviceSpecificOutputPath)$(_AppBundleName).app</AppBundleDir>
			<_AppBundlePath>$(AppBundleDir)\</_AppBundlePath>
		</PropertyGroup>
	</Target>

	<Target Name="GetAppBundleDir" DependsOnTargets="_GenerateBundleName" Returns="$(AppBundleDir)"/>

	<PropertyGroup>
		<_IsWatchExtension>false</_IsWatchExtension>
	</PropertyGroup>

	<Target Name="_CompileAppManifest"
		DependsOnTargets="_DetectSdkLocations;_DetectAppManifest;_GenerateBundleName;_DetectSigningIdentity;_PrepareResourceRules;_ResolveWatchAppReferences"
		Inputs="$(_AppManifest);@(_PartialAppManifest)"
		Outputs="$(_AppBundlePath)Info.plist" >
		<CompileAppManifest
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleName="$(_AppBundleName)"
			AppBundleDir="$(AppBundleDir)"
			AppManifest="$(_AppManifest)"
			Architecture="$(MtouchArch)"
			AssemblyName="$(AssemblyName)"
			BundleIdentifier="$(_BundleIdentifier)"
			DefaultSdkVersion="$(MtouchSdkVersion)"
			IsAppExtension="$(IsAppExtension)"
			IsWatchApp="$(IsWatchApp)"
			IsWatchExtension="$(_IsWatchExtension)"
			PartialAppManifests="@(_PartialAppManifest)"
			ResourceRules="$(_PreparedResourceRules)"
			TargetFrameworkIdentifier="$(TargetFrameworkIdentifier)"
			SdkPlatform="$(_SdkPlatform)"
			SdkIsSimulator="$(_SdkIsSimulator)"
			>
		</CompileAppManifest>

		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(AppBundleDir).dSYM" />
		<Delete SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Files="$(OutputPath)*.bcsymbolmap" />
	</Target>

	<Target Name="_CompileITunesMetadata" Condition="'$(ComputedPlatform)' == 'iPhone' And '$(IsAppExtension)' == 'false' And '$(IsWatchApp)' == 'false'"
		DependsOnTargets="_DetectSdkLocations;_DetectAppManifest;_GenerateBundleName;_CompileAppManifest"
		Inputs="$(_AppManifest);@(ITunesMetadata)"
		Outputs="$(OutputPath)iTunesMetadata.plist" >
		<CompileITunesMetadata
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleDir="$(AppBundleDir)"
			ITunesMetadata="@(ITunesMetadata)"
			OutputPath="$(OutputPath)iTunesMetadata.plist"
		/>
	</Target>

	<Target Name="_CollectITunesArtwork" Condition="'$(ComputedPlatform)' == 'iPhone' And '$(IsAppExtension)' == 'false' And '$(IsWatchApp)' == 'false'">
		<CollectITunesArtwork
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ITunesArtwork="@(ITunesArtwork)"
			>
			<Output TaskParameter="ITunesArtworkWithLogicalNames" ItemName="_ITunesArtworkWithLogicalName"/>
		</CollectITunesArtwork>
	</Target>

	<Target Name="_CopyITunesArtwork" Condition="'$(ComputedPlatform)' == 'iPhone' And '$(IsAppExtension)' == 'false' And '$(IsWatchApp)' == 'false'"
		DependsOnTargets="_CollectITunesArtwork"
		Inputs="@(ITunesMetadata)" Outputs="$(OutputPath)%(_ITunesArtworkWithLogicalName.LogicalName)">
		<Copy
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			SourceFiles="@(_ITunesArtworkWithLogicalName)"
			DestinationFiles="$(OutputPath)%(_ITunesArtworkWithLogicalName.LogicalName)"
		/>
	</Target>

	<Target Name="_GetNativeExecutableName" DependsOnTargets="_DetectAppManifest;_GenerateBundleName;_CompileAppManifest">
		<GetNativeExecutableName
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppManifest="$(_AppBundlePath)Info.plist"
			>
			<Output TaskParameter="ExecutableName" PropertyName="_ExecutableName" />
		</GetNativeExecutableName>

		<PropertyGroup>
			<_NativeExecutable>$(_AppBundlePath)$(_ExecutableName)</_NativeExecutable>
		</PropertyGroup>
	</Target>

	<PropertyGroup>
		<_CompileToNativeDependsOn>
			_DetectAppManifest;
			_DetectSdkLocations;
			_GenerateBundleName;
			_DetectSigningIdentity;
			_CompileEntitlements;
			_CompileAppManifest;
			_ResolveAppExtensionReferences;
			_GetNativeExecutableName
		</_CompileToNativeDependsOn>
	</PropertyGroup>

	<Target Name="_CompileToNative" DependsOnTargets="$(_CompileToNativeDependsOn)"
		Inputs="$(TargetDir)$(TargetFileName)"
		Outputs="$(_NativeExecutable)">

		<ItemGroup>
			<MTouchReferencePath Include="@(ReferenceCopyLocalPaths)" Condition="'%(Extension)' == '.dll'" />
		</ItemGroup>

		<MTouch
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(MtouchExe)"
			ToolPath="$(MtouchPath)"
			AppBundleDir="$(AppBundleDir)"
			AppManifest="$(_AppBundlePath)Info.plist"
			Architectures="$(TargetArchitectures)"
			Entitlements="$(CodesignEntitlements)"
			ExecutableName="$(_ExecutableName)"
			CompiledEntitlements="$(IntermediateOutputPath)Entitlements.xcent"
			Debug="$(MtouchDebug)"
			EnableGenericValueTypeSharing="$(MtouchEnableGenericValueTypeSharing)"
			ExtraArgs="$(MtouchExtraArgs)"
			FastDev="$(MtouchFastDev)"
			I18n="$(MtouchI18n)"
			IntermediateOutputPath="$(DeviceSpecificIntermediateOutputPath)mtouch-cache"
			IsAppExtension="$(IsAppExtension)"
			LinkMode="$(MtouchLink)"
			MainAssembly="$(TargetPath)"
			NativeReferences="@(NativeReference)"
			OutputPath="$(OutputPath)"
			Profiling="$(MtouchProfiling)"
			ProjectDir="$(MtouchProjectDirectory)"
			References="@(ReferencePath);@(MTouchReferencePath)"
			SdkRoot="$(_SdkDevPath)"
			SdkIsSimulator="$(_SdkIsSimulator)"
			SdkVersion="$(MtouchSdkVersion)"
			SymbolsList="$(_MtouchSymbolsList)"
			TargetFrameworkIdentifier="$(TargetFrameworkIdentifier)"
			TargetFrameworkVersion="$(TargetFrameworkVersion)"
			UseLlvm="$(MtouchUseLlvm)"
			UseRefCounting="$(MtouchUseRefCounting)"
			UseSGen="$(MtouchUseSGen)"
			UseThumb="$(MtouchUseThumb)"
			AppExtensionReferences="@(_ResolvedAppExtensionReferences)"
			>
			<Output TaskParameter="CompiledArchitectures" PropertyName="_CompiledArchitectures" />
		</MTouch>

		<RemoveDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(AppBundleDir).dSYM" />
		<Delete SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Files="$(OutputPath)*.bcsymbolmap" />
	</Target>

	<Target Name="_GenerateFrameworkDebugSymbols" Condition="'$(ComputedPlatform)' == 'iPhone' And '$(IsWatchApp)' != 'true'" DependsOnTargets="_CompileToNative;_CollectFrameworks"
		Inputs="%(_Frameworks.Identity)"
		Outputs="$(AppBundleDir)\..\%(_Frameworks.Filename).framework.dSYM\Contents\Info.plist"
		>

		<!-- run dsymutil on embedded frameworks -->
		<DSymUtil
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleDir="$(AppBundleDir)"
			Architectures=""
			DSymDir="$(AppBundleDir)\..\%(_Frameworks.Filename).framework.dSYM"
			Executable="%(_Frameworks.Identity)"
			ToolExe="$(DSymUtilExe)"
			ToolPath="$(DSymUtilPath)">
		</DSymUtil>

		<!--- strip embedded frameworks -->
		<SymbolStrip
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '$(MtouchDebug)' != 'true'"
			Executable="%(_Frameworks.Identity)"
			IsFramework="true"
			SymbolFile=""
		>
		</SymbolStrip>

		<!-- _GenerateDebugSymbols will run spotlight to index the dSYMs -->
	</Target>

	<Target Name="_ParseExtraMtouchArgs">
		<ParseExtraMtouchArgs
			ExtraArgs="$(MTouchExtraArgs)"
			NoSymbolStrip="$(MtouchNoSymbolStrip)"
			NoDSymUtil="$(MtouchNoDSymUtil)"
			>
			<Output TaskParameter="NoSymbolStrip" PropertyName="MtouchNoSymbolStrip"/>
			<Output TaskParameter="NoDSymUtil" PropertyName="MtouchNoDSymUtil"/>
		</ParseExtraMtouchArgs>
	</Target>

	<Target Name="_GenerateDebugSymbols" Condition="'$(ComputedPlatform)' == 'iPhone' And '$(IsWatchApp)' == 'false'" DependsOnTargets="_CompileToNative;_ParseExtraMtouchArgs;_GenerateFrameworkDebugSymbols"
		Inputs="$(_NativeExecutable)"
		Outputs="$(AppBundleDir).dSYM\Contents\Info.plist">
		<!--- run dsymutil on the main bundle -->
		<DSymUtil
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '$(MtouchNoDSymUtil)' == 'false'"
			AppBundleDir="$(AppBundleDir)"
			Architectures="$(_CompiledArchitectures)"
			DSymDir="$(AppBundleDir).dSYM"
			Executable="$(_NativeExecutable)"
			ToolExe="$(DSymUtilExe)"
			ToolPath="$(DSymUtilPath)"
		>
		</DSymUtil>

		<!--- strip the main executable -->
		<SymbolStrip
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '$(MtouchDebug)' == 'false' And '$(MtouchNoSymbolStrip)' == 'false'"
			Executable="$(_NativeExecutable)"
			IsFramework="false"
			SymbolFile="$(_MtouchSymbolsList)"
		>
		</SymbolStrip>

		<!-- make sure spotlight indexes everything we've built -->
		<SpotlightIndexer
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '$(MtouchNoDSymUtil)' == 'false'"
			Input="$(AppBundleDir)/../"
		>
		</SpotlightIndexer>
	</Target>

	<Target Name="_CreateDebugSettings" Condition="'$(MtouchDebug)' == 'true' And '$(IsWatchApp)' == 'false'"
		DependsOnTargets="_CopyResourcesToBundle"
		Outputs="$(_AppBundlePath)Settings.bundle\Root.plist" >
		<CreateDebugSettings
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleDir="$(AppBundleDir)"
			DebuggerPort="$(IOSDebuggerPort)"
			>
		</CreateDebugSettings>
	</Target>

	<Target Name="_CreateDebugConfiguration" Condition="'$(MtouchDebug)' == 'true' And '$(IsWatchApp)' == 'false'"
		DependsOnTargets="_CopyResourcesToBundle"
		Outputs="$(_AppBundlePath)MonoTouchDebugConfiguration.txt" >
		<CreateDebugConfiguration
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleDir="$(AppBundleDir)"
			DebugOverWiFi="$(IOSDebugOverWiFi)"
			DebuggerHosts="$(IOSDebuggerHosts)"
			DebuggerPort="$(IOSDebuggerPort)"
			SdkIsSimulator="$(_SdkIsSimulator)"
			>
		</CreateDebugConfiguration>
	</Target>

	<Target Name="_CollectPngImages" DependsOnTargets="_CollectBundleResources">
		<ItemGroup>
			<_PngImage Include="@(_BundleResourceWithLogicalName)" Condition="'%(Extension)' == '.png' And '%(Optimize)' == 'true'" />
			<FileWrites Include="$(IntermediateOutputPath)optimized\%(_PngImage.LogicalName)" />
		</ItemGroup>
	</Target>

	<Target Name="_CoreOptimizePngImages"
		DependsOnTargets="_CollectPngImages;_DetectSdkLocations"
		Inputs="@(_PngImage)"
		Outputs="$(IntermediateOutputPath)optimized\%(_PngImage.LogicalName)"
		>

		<OptimizeImage
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(PngCrushExe)"
			ToolPath="$(PngCrushPath)"
			SdkDevPath="$(_SdkDevPath)"
			InputImage="%(_PngImage.Identity)"
			OutputImage="$(IntermediateOutputPath)optimized\%(_PngImage.LogicalName)">
		</OptimizeImage>
	</Target>

	<Target Name="_AfterCoreOptimizePngImages" Condition="'@(_PngImage)' != ''">
		<ItemGroup>
			<_BundleResourceWithLogicalName Remove="@(_PngImage)" />
		</ItemGroup>

		<CreateItem Include="$(IntermediateOutputPath)optimized\%(_PngImage.LogicalName)" AdditionalMetadata="LogicalName=%(_PngImage.LogicalName);Optimize='false';ResourceTags=%(_PngImage.ResourceTags)">
			<Output TaskParameter="Include" ItemName="_BundleResourceWithLogicalName" />
		</CreateItem>
	</Target>

	<Target Name="_CollectPropertyLists" DependsOnTargets="_CollectBundleResources">
		<ItemGroup>
			<_PropertyList Include="@(_BundleResourceWithLogicalName)" Condition="'%(Extension)' == '.plist' And '%(Optimize)' == 'true'" />
			<FileWrites Include="$(IntermediateOutputPath)optimized\%(_PropertyList.LogicalName)" />
		</ItemGroup>
	</Target>

	<Target Name="_CoreOptimizePropertyLists"
		DependsOnTargets="_CollectPropertyLists;_DetectSdkLocations"
		Inputs="@(_PropertyList)"
		Outputs="$(IntermediateOutputPath)optimized\%(_PropertyList.LogicalName)"
		>

		<OptimizePropertyList
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(PlUtilExe)"
			ToolPath="$(PlUtilPath)"
			Input="%(_PropertyList.Identity)"
			Output="$(IntermediateOutputPath)optimized\%(_PropertyList.LogicalName)">
		</OptimizePropertyList>
	</Target>

	<Target Name="_AfterCoreOptimizePropertyLists" Condition="'@(_PropertyList)' != ''">
		<ItemGroup>
			<_BundleResourceWithLogicalName Remove="@(_PropertyList)" />
		</ItemGroup>

		<CreateItem Include="$(IntermediateOutputPath)optimized\%(_PropertyList.LogicalName)" AdditionalMetadata="LogicalName=%(_PropertyList.LogicalName);Optimize='false'">
			<Output TaskParameter="Include" ItemName="_BundleResourceWithLogicalName" />
		</CreateItem>
	</Target>

	<Target Name="_CollectLocalizationFiles" DependsOnTargets="_CollectBundleResources">
		<ItemGroup>
			<_LocalizationFile Include="@(_BundleResourceWithLogicalName)" Condition="'%(Extension)' == '.strings' And '%(Optimize)' == 'true'" />
			<FileWrites Include="$(IntermediateOutputPath)optimized\%(_LocalizationFile.LogicalName)" />
		</ItemGroup>
	</Target>

	<Target Name="_CoreOptimizeLocalizationFiles"
		DependsOnTargets="_CollectLocalizationFiles;_DetectSdkLocations"
		Inputs="@(_LocalizationFile)"
		Outputs="$(IntermediateOutputPath)optimized\%(_LocalizationFile.LogicalName)"
		>

		<OptimizePropertyList
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(PlUtilExe)"
			ToolPath="$(PlUtilPath)"
			Input="%(_LocalizationFile.Identity)"
			Output="$(IntermediateOutputPath)optimized\%(_LocalizationFile.LogicalName)">
		</OptimizePropertyList>
	</Target>

	<Target Name="_AfterCoreOptimizeLocalizationFiles" Condition="'@(_LocalizationFile)' != ''">
		<ItemGroup>
			<_BundleResourceWithLogicalName Remove="@(_LocalizationFile)" />
		</ItemGroup>

		<CreateItem Include="$(IntermediateOutputPath)optimized\%(_LocalizationFile.LogicalName)" AdditionalMetadata="LogicalName=%(_LocalizationFile.LogicalName);Optimize='false'">
			<Output TaskParameter="Include" ItemName="_BundleResourceWithLogicalName" />
		</CreateItem>
	</Target>

	<Target Name="_CollectColladaAssets">
		<CollectBundleResources
			SessionId="$(BuildSessionId)"
			BundleResources="@(Collada)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)">
			<Output TaskParameter="BundleResourcesWithLogicalNames" ItemName="_ColladaAssetWithLogicalName" />
		</CollectBundleResources>
	</Target>

	<Target Name="_CoreCompileColladaAssets"
		DependsOnTargets="_CollectColladaAssets;_DetectSdkLocations"
		Inputs="@(_ColladaAssetWithLogicalName)"
		Outputs="$(IntermediateOutputPath)%(_ColladaAssetWithLogicalName.LogicalName)"
		>

		<ScnTool
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(ScnToolExe)"
			ToolPath="$(ScnToolPath)"
			SdkRoot="$(_SdkRoot)"
			SdkDevPath="$(_SdkDevPath)"
			SdkVersion="$(MtouchSdkVersion)"
			IntermediateOutputPath="$(IntermediateOutputPath)"
			InputScene="%(_ColladaAssetWithLogicalName.Identity)"
			OutputScene="$(IntermediateOutputPath)%(_ColladaAssetWithLogicalName.LogicalName)">
		</ScnTool>

		<CreateItem Include="$(IntermediateOutputPath)%(_ColladaAssetWithLogicalName.LogicalName)" AdditionalMetadata="LogicalName=%(_ColladaAssetWithLogicalName.LogicalName);Optimize='False'">
			<Output TaskParameter="Include" ItemName="_BundleResourceWithLogicalName" />
		</CreateItem>
	</Target>

	<Target Name="_CompileImageAssets" DependsOnTargets="_DetectAppManifest;_DetectSdkLocations;_CoreCompileImageAssets" />

	<Target Name="_CoreCompileImageAssets" DependsOnTargets="_DetectAppManifest;_DetectSdkLocations;_ComputeTargetArchitectures">
		<ACTool
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '@(ImageAsset)' != ''"
			ToolExe="$(ACToolExe)"
			ToolPath="$(ACToolPath)"
			AppManifest="$(_AppManifest)"
			DeviceModel="$(TargetDeviceModel)"
			DeviceOSVersion="$(TargetDeviceOSVersion)"
			ImageAssets="@(ImageAsset)"
			OptimizePNGs="$(OptimizePNGs)"
			OutputPath="$(OutputPath)"
			IntermediateOutputPath="$(DeviceSpecificIntermediateOutputPath)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)"
			SdkDevPath="$(_SdkDevPath)"
			SdkBinPath="$(_SdkBinPath)"
			SdkUsrPath="$(_SdkUsrPath)"
			SdkPlatform="$(_SdkPlatform)"
			SdkVersion="$(MtouchSdkVersion)">
			<Output TaskParameter="PartialAppManifest" ItemName="FileWrites" />
			<Output TaskParameter="OutputManifests" ItemName="FileWrites" />
			<Output TaskParameter="BundleResources" ItemName="FileWrites" />
			<Output TaskParameter="PartialAppManifest" ItemName="_PartialAppManifest" />
			<Output TaskParameter="BundleResources" ItemName="_BundleResourceWithLogicalName" />
		</ACTool>
	</Target>

	<Target Name="_CompileSceneKitAssets" DependsOnTargets="_DetectAppManifest;_DetectSdkLocations;_CoreCompileSceneKitAssets" />

	<Target Name="_CoreCompileSceneKitAssets">
		<CompileSceneKitAssets
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(CopySceneKitAssetsExe)"
			ToolPath="$(CopySceneKitAssetsPath)"
			SceneKitAssets="@(SceneKitAsset)"
			IntermediateOutputPath="$(IntermediateOutputPath)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)"
			SdkDevPath="$(_SdkDevPath)"
			SdkRoot="$(_SdkRoot)"
			SdkVersion="$(MtouchSdkVersion)">
			<Output TaskParameter="BundleResources" ItemName="FileWrites" />
			<Output TaskParameter="BundleResources" ItemName="_BundleResourceWithLogicalName" />
		</CompileSceneKitAssets>
	</Target>
	
	<Target Name="_CompileInterfaceDefinitions" DependsOnTargets="_DetectAppManifest;_DetectSdkLocations;_CoreCompileInterfaceDefinitions" />

	<Target Name="_CoreCompileInterfaceDefinitions">
		<IBTool
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(IBToolExe)"
			ToolPath="$(IBToolPath)"
			AppManifest="$(_AppManifest)"
			InterfaceDefinitions="@(InterfaceDefinition)"
			IntermediateOutputPath="$(IntermediateOutputPath)"
			IsWatchApp="$(IsWatchApp)"
			IsWatch2App="$(IsWatch2App)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)"
			SdkDevPath="$(_SdkDevPath)"
			SdkBinPath="$(_SdkBinPath)"
			SdkUsrPath="$(_SdkUsrPath)"
			SdkRoot="$(_SdkRoot)"
			SdkPlatform="$(_SdkPlatform)"
			SdkVersion="$(MtouchSdkVersion)">
			<Output TaskParameter="BundleResources" ItemName="FileWrites" />
			<Output TaskParameter="BundleResources" ItemName="_BundleResourceWithLogicalName" />
		</IBTool>
	</Target>

	<Target Name="_CompileTextureAtlases" DependsOnTargets="_DetectAppManifest;_DetectSdkLocations;_CoreCompileTextureAtlases" />

	<Target Name="_CoreCompileTextureAtlases">
		<TextureAtlas
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(TextureAtlasExe)"
			ToolPath="$(TextureAtlasPath)"
			AtlasTextures="@(AtlasTexture)"
			IntermediateOutputPath="$(IntermediateOutputPath)"
			ProjectDir="$(MSBuildProjectDirectory)"
			ResourcePrefix="$(IPhoneResourcePrefix)"
			SdkDevPath="$(_SdkDevPath)"
			SdkBinPath="$(_SdkBinPath)"
			SdkUsrPath="$(_SdkUsrPath)">
			<Output TaskParameter="BundleResources" ItemName="FileWrites" />
			<Output TaskParameter="BundleResources" ItemName="_BundleResourceWithLogicalName" />
		</TextureAtlas>
	</Target>

	<Target Name="_CreatePkgInfo" Condition="'$(IsAppExtension)' == 'false'" DependsOnTargets="_GenerateBundleName" Outputs="$(_AppBundlePath)PkgInfo">
		<CreatePkgInfo SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" OutputPath="$(_AppBundlePath)PkgInfo" />
	</Target>

	<Target Name="_EmbedMobileProvision" DependsOnTargets="_GenerateBundleName;_DetectSigningIdentity"
		Outputs="$(_AppBundlePath)embedded.mobileprovision">
		<EmbedMobileProvision
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleDir="$(AppBundleDir)"
			ProvisioningProfile="$(_ProvisioningProfile)"
			>
		</EmbedMobileProvision>
	</Target>

	<Target Name="_CompileEntitlements" Condition="'$(ComputedPlatform)' == 'iPhone' Or '$(CodesignEntitlements)' != ''" DependsOnTargets="_DetectSdkLocations;_GenerateBundleName;_DetectSigningIdentity"
		Outputs="$(IntermediateOutputPath)Entitlements.xcent">
		<CompileEntitlements
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleDir="$(AppBundleDir)"
			AppIdentifier="$(_AppIdentifier)"
			BundleIdentifier="$(_BundleIdentifier)"
			Entitlements="$(CodesignEntitlements)"
			CompiledEntitlements="$(IntermediateOutputPath)Entitlements.xcent"
			IsAppExtension="$(IsAppExtension)"
			ProvisioningProfile="$(_ProvisioningProfile)"
			SdkVersion="$(MtouchSdkVersion)"
			>
		</CompileEntitlements>
	</Target>

	<Target Name="_PrepareResourceRules" DependsOnTargets="_DetectSdkLocations;_GenerateBundleName">
		<PrepareResourceRules
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '$(CodesignResourceRules)' != '' And '$(ComputedPlatform)' == 'iPhone'"
			AppBundleDir="$(AppBundleDir)"
			ResourceRules="$(CodesignResourceRules)"
			SdkVersion="$(MtouchSdkVersion)"
			>
			<Output TaskParameter="PreparedResourceRules" PropertyName="_PreparedResourceRules"/>
		</PrepareResourceRules>
	</Target>

	<Target Name="_SeparateAppExtensionReferences" BeforeTargets="AssignProjectConfiguration" Condition="'$(IsAppExtension)' == 'false'">
		<CreateItem Include="@(ProjectReference)" PreserveExistingMetadata="true" Condition="'%(Identity)' != '' And '%(ProjectReference.IsAppExtension)' == 'true'">
			<Output ItemName="_AppExtensionReference" TaskParameter="Include" />
		</CreateItem>

		<ItemGroup>
			<ProjectReference Remove="@(_AppExtensionReference)" />
		</ItemGroup>

		<!--<Warning Text="_SeparateAppExtensionReferences: @(_AppExtensionReference)"/>-->
	</Target>

	<Target Name="_AssignAppExtensionConfiguration" Condition="'@(_AppExtensionReference)' != ''">
		<!-- assign configs if building a solution file -->
		<AssignProjectConfiguration
			ProjectReferences = "@(_AppExtensionReference)"
			SolutionConfigurationContents = "$(CurrentSolutionConfigurationContents)"
			Condition="'$(CurrentSolutionConfigurationContents)' != ''">

			<Output TaskParameter="AssignedProjects" ItemName="_AppExtensionReferenceWithConfiguration"/>
		</AssignProjectConfiguration>

		<!-- Else, just -->
		<CreateItem Include="@(_AppExtensionReference)"
					Condition="'$(CurrentSolutionConfigurationContents)' == ''">
			<Output TaskParameter="Include" ItemName="_AppExtensionReferenceWithConfiguration"/>
		</CreateItem>

		<!--<Warning Text="_AssignAppExtensionConfiguration: @(_AppExtensionReferenceWithConfiguration)"/>-->
	</Target>

	<!-- Split iOS App Extension projects into 2 lists
		_AppExtensionReferenceWithConfigurationExistent: Projects existent on disk
		_AppExtensionReferenceWithConfigurationNonExistent: Projects non-existent on disk -->
	<Target Name="_SplitAppExtensionReferencesByExistent" DependsOnTargets="_AssignAppExtensionConfiguration">
		<CreateItem Include="@(_AppExtensionReferenceWithConfiguration)" Condition="'@(_AppExtensionReferenceWithConfiguration)' != ''">
			<Output TaskParameter="Include" ItemName="_AppExtensionReferenceWithConfigurationExistent" 
				Condition="Exists ('%(_AppExtensionReferenceWithConfiguration.Identity)')"/>

			<Output TaskParameter="Include" ItemName="_AppExtensionReferenceWithConfigurationNonExistent"
				Condition="!Exists ('%(_AppExtensionReferenceWithConfiguration.Identity)')"/>
		</CreateItem>

		<!--<Warning Text="_SplitAppExtensionReferencesByExistent: @(_AppExtensionReferenceWithConfigurationExistent)"/>-->
	</Target>

	<Target Name="_ResolveAppExtensionReferences" DependsOnTargets="_SplitAppExtensionReferencesByExistent">
		<!-- If building from a .sln.proj or from IDE, then referenced projects have already
		     been built, so just get the target paths -->
		<MSBuild
			Projects="@(_AppExtensionReferenceWithConfigurationExistent)"
			Targets="GetBundleTargetPath"
			Properties="%(_AppExtensionReferenceWithConfigurationExistent.SetConfiguration); %(_AppExtensionReferenceWithConfigurationExistent.SetPlatform)"
			Condition="'@(_AppExtensionReferenceWithConfigurationExistent)' != '' and ('$(BuildingSolutionFile)' == 'true' or '$(BuildingInsideVisualStudio)' == 'true')">

			<Output TaskParameter="TargetOutputs" ItemName="_ResolvedAppExtensionReferences" Condition="'%(_AppExtensionReferenceWithConfigurationExistent.ReferenceOutputAssembly)' != 'false'"/>
		</MSBuild>

		<!-- Building a project directly, build the referenced projects also -->
		<MSBuild
			Projects="@(_AppExtensionReferenceWithConfigurationExistent)"
			Properties="%(_AppExtensionReferenceWithConfigurationExistent.SetConfiguration); %(_AppExtensionReferenceWithConfigurationExistent.SetPlatform)"
			Condition="'@(_AppExtensionReferenceWithConfigurationExistent)' != '' and '$(BuildingSolutionFile)' != 'true' and '$(BuildingInsideVisualStudio)' != 'true' ">

			<Output TaskParameter="TargetOutputs" ItemName="_ResolvedAppExtensionReferences" Condition="'%(_AppExtensionReferenceWithConfigurationExistent.ReferenceOutputAssembly)' != 'false'"/>
		</MSBuild>

		<Warning Text="Referenced iOS App Extension Project %(_AppExtensionReferenceWithConfigurationNonExistent.Identity) not found, ignoring."
			 Condition="'@(_AppExtensionReferenceWithConfigurationNonExistent)' != ''"/>
	</Target>

	<Target Name="_DetectBundleIdentifier" DependsOnTargets="_DetectAppManifest">
		<DetectBundleIdentifier
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleName="$(_AppBundleName)"
			AppManifest="$(_AppManifest)"
			SdkIsSimulator="$(_SdkIsSimulator)"
			>

			<Output TaskParameter="DetectedBundleId" PropertyName="_BundleIdentifier" />
		</DetectBundleIdentifier>
	</Target>

	<Target Name="_CopyAppExtensionsToBundle" Condition="'$(IsAppExtension)' == 'false'" DependsOnTargets="_ResolveAppExtensionReferences">
		<MakeDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)' And '@(_ResolvedAppExtensionReferences)' != ''" Directories="$(_AppBundlePath)PlugIns" />

		<Ditto
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '@(_ResolvedAppExtensionReferences)' != '' And '%(_ResolvedAppExtensionReferences.Identity)' != ''"
			ToolExe="$(DittoExe)"
			ToolPath="$(DittoPath)"
			Source="@(_ResolvedAppExtensionReferences)"
			Destination="$(_AppBundlePath)PlugIns\%(_ResolvedAppExtensionReferences.FileName)%(_ResolvedAppExtensionReferences.Extension)"
		/>
	</Target>

	<Target Name="_ValidateAppBundle" Condition="'$(IsAppExtension)' == 'false' And '$(IsWatchApp)' == 'false'" DependsOnTargets="_DetectSdkLocations">
		<ValidateAppBundleTask
			Condition="'$(MtouchTargetsEnabled)'"
			SessionId="$(BuildSessionId)"
			AppBundlePath="$(_AppBundlePath)"
			SdkIsSimulator="$(_SdkIsSimulator)"
		/>
	</Target>

	<Target Name="_SeparateWatchAppReferences" BeforeTargets="AssignProjectConfiguration" Condition="'$(IsAppExtension)' == 'true' Or '$(OutputType)' == 'Exe'">
		<CreateItem Include="@(ProjectReference)" PreserveExistingMetadata="true" Condition="'%(Identity)' != '' And '%(ProjectReference.IsWatchApp)' == 'true'">
			<Output ItemName="_WatchAppReference" TaskParameter="Include" />
		</CreateItem>

		<ItemGroup>
			<ProjectReference Remove="@(_WatchAppReference)" />
		</ItemGroup>

		<!--<Warning Text="_SeparateWatchAppReferences: '@(_WatchAppReference)'"/>-->
	</Target>

	<Target Name="_AssignWatchAppConfiguration" Condition="'@(_WatchAppReference)' != ''">
		<!-- assign configs if building a solution file -->
		<AssignProjectConfiguration
			ProjectReferences = "@(_WatchAppReference)"
			SolutionConfigurationContents = "$(CurrentSolutionConfigurationContents)"
			Condition="'$(CurrentSolutionConfigurationContents)' != ''">

			<Output TaskParameter="AssignedProjects" ItemName="_WatchAppReferenceWithConfiguration"/>
		</AssignProjectConfiguration>

		<!-- Else, just -->
		<CreateItem Include="@(_WatchAppReference)" 
					Condition="'$(CurrentSolutionConfigurationContents)' == ''">
			<Output TaskParameter="Include" ItemName="_WatchAppReferenceWithConfiguration"/>
		</CreateItem>

		<!--<Warning Text="_AssignWatchAppConfiguration: '@(_WatchAppReferenceWithConfiguration)'"/>-->
	</Target>

	<!-- Split iOS Watch App projects into 2 lists
		_WatchAppReferenceWithConfigurationExistent: Projects existent on disk
		_WatchAppReferenceWithConfigurationNonExistent: Projects non-existent on disk -->
	<Target Name="_SplitWatchAppReferencesByExistent" DependsOnTargets="_AssignWatchAppConfiguration">
		<CreateItem Include="@(_WatchAppReferenceWithConfiguration)" Condition="'@(_WatchAppReferenceWithConfiguration)' != ''">
			<Output TaskParameter="Include" ItemName="_WatchAppReferenceWithConfigurationExistent" 
				Condition="Exists ('%(_WatchAppReferenceWithConfiguration.Identity)')"/>

			<Output TaskParameter="Include" ItemName="_WatchAppReferenceWithConfigurationNonExistent"
				Condition="!Exists ('%(_WatchAppReferenceWithConfiguration.Identity)')"/>
		</CreateItem>

		<!--<Warning Text="_SplitWatchAppReferencesByExistent: '@(_WatchAppReferenceWithConfigurationExistent)'"/>-->
	</Target>

	<Target Name="_ResolveWatchAppReferences" DependsOnTargets="_SplitWatchAppReferencesByExistent">
		<!-- If building from a .sln.proj or from IDE, then referenced projects have already
		     been built, so just get the target paths -->
		<MSBuild
			Projects="@(_WatchAppReferenceWithConfigurationExistent)"
			Targets="GetBundleTargetPath"
			Properties="%(_WatchAppReferenceWithConfigurationExistent.SetConfiguration); %(_WatchAppReferenceWithConfigurationExistent.SetPlatform)"
			Condition="'@(_WatchAppReferenceWithConfigurationExistent)' != '' and ('$(BuildingSolutionFile)' == 'true' or '$(BuildingInsideVisualStudio)' == 'true')">

			<Output TaskParameter="TargetOutputs" ItemName="_ResolvedWatchAppReferences" Condition="'%(_WatchAppReferenceWithConfigurationExistent.ReferenceOutputAssembly)' != 'false'"/>
		</MSBuild>

		<!-- Building a project directly, build the referenced projects also -->
		<MSBuild
			Projects="@(_WatchAppReferenceWithConfigurationExistent)"
			Properties="%(_WatchAppReferenceWithConfigurationExistent.SetConfiguration); %(_WatchAppReferenceWithConfigurationExistent.SetPlatform)"
			Condition="'@(_WatchAppReferenceWithConfigurationExistent)' != '' and '$(BuildingSolutionFile)' != 'true' and '$(BuildingInsideVisualStudio)' != 'true' ">

			<Output TaskParameter="TargetOutputs" ItemName="_ResolvedWatchAppReferences" Condition="'%(_WatchAppReferenceWithConfigurationExistent.ReferenceOutputAssembly)' != 'false'"/>
		</MSBuild>

		<Warning Text="Referenced iOS Watch App Project %(_WatchAppReferenceWithConfigurationNonExistent.Identity) not found, ignoring."
			 Condition="'@(_WatchAppReferenceWithConfigurationNonExistent)' != ''"/>

		<PropertyGroup>
			<_IsWatchExtension Condition="'@(_ResolvedWatchAppReferences)' != ''">true</_IsWatchExtension>
		</PropertyGroup>
	</Target>

	<Target Name="_CopyWatchAppsToBundle" Condition="'$(IsAppExtension)' == 'true'" DependsOnTargets="_ResolveWatchAppReferences">
		<Ditto
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '@(_ResolvedWatchAppReferences)' != '' And '%(_ResolvedWatchAppReferences.Identity)' != ''"
			ToolExe="$(DittoExe)"
			ToolPath="$(DittoPath)"
			Source="@(_ResolvedWatchAppReferences)"
			Destination="$(_AppBundlePath)%(_ResolvedWatchAppReferences.FileName)%(_ResolvedWatchAppReferences.Extension)"
		/>
	</Target>

	<Target Name="_CopyWatch2AppsToBundle" Condition="'$(OutputType)' == 'Exe'" DependsOnTargets="_ResolveWatchAppReferences">
		<Ditto
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '@(_ResolvedWatchAppReferences)' != '' And '%(_ResolvedWatchAppReferences.Identity)' != ''"
			ToolExe="$(DittoExe)"
			ToolPath="$(DittoPath)"
			Source="@(_ResolvedWatchAppReferences)"
			Destination="$(_AppBundlePath)Watch\%(_ResolvedWatchAppReferences.FileName)%(_ResolvedWatchAppReferences.Extension)"
		/>
	</Target>

	<Target Name="_CollectNativeLibraries">
		<ItemGroup>
			<!---<_NativeLibrary Include="@(NativeReference->'$(_AppBundlePath)%(Filename)%(Extension)')" Condition="'%(Kind)' == 'dynamic'" />-->
			<_NativeLibrary Include="$(_AppBundlePath)**\*.dylib" />
		</ItemGroup>
	</Target>

	<Target Name="_CollectFrameworks" Condition="'$(_IsContainerApp)' == 'true'" DependsOnTargets="_CompileToNative">
		<CollectFrameworks
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundlePath="$(_AppBundlePath)"
			>

			<Output TaskParameter="Frameworks" ItemName="_Frameworks"/>
		</CollectFrameworks>
	</Target>

	<Target Name="_CodesignNativeLibraries" Condition="'$(ComputedPlatform)' == 'iPhone' Or '$(CodesignEntitlements)' != ''" DependsOnTargets="_DetectSigningIdentity;_CollectNativeLibraries">
		<Codesign
			Condition="'$(MtouchTargetsEnabled)' And '@(_NativeLibrary)' != ''"
			SessionId="$(BuildSessionId)"
			ToolExe="$(CodesignExe)"
			ToolPath="$(CodesignPath)"
			CodesignAllocate="$(_CodesignAllocate)"
			Resource="%(_NativeLibrary.Identity)"
			SigningKey="$(_CodeSigningKey)"
			ExtraArgs="$(CodesignExtraArgs)"
			>
		</Codesign>
	</Target>

	<Target Name="_CodesignFrameworks" Condition="'$(ComputedPlatform)' == 'iPhone' Or '$(CodesignEntitlements)' != ''" DependsOnTargets="_DetectSigningIdentity;_CollectFrameworks">
		<Codesign
			Condition="'$(MtouchTargetsEnabled)' And '@(_Frameworks)' != ''"
			SessionId="$(BuildSessionId)"
			ToolExe="$(CodesignExe)"
			ToolPath="$(CodesignPath)"
			CodesignAllocate="$(_CodesignAllocate)"
			Resource="%(_Frameworks.Identity)"
			SigningKey="$(_CodeSigningKey)"
			ExtraArgs="$(CodesignExtraArgs)"
			>
		</Codesign>
	</Target>

	<Target Name="_CodesignAppBundle" Condition="'$(ComputedPlatform)' == 'iPhone' Or '$(CodesignEntitlements)' != ''" DependsOnTargets="$(_CodesignAppBundleDependsOn)">
		<Codesign
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(CodesignExe)"
			ToolPath="$(CodesignPath)"
			CodesignAllocate="$(_CodesignAllocate)"
			Entitlements="$(IntermediateOutputPath)Entitlements.xcent"
			ResourceRules="$(_PreparedResourceRules)"
			Resource="$(AppBundleDir)"
			SigningKey="$(_CodeSigningKey)"
			ExtraArgs="$(CodesignExtraArgs)"
			>
		</Codesign>

		<Touch
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And Exists ('$(AppBundleDir).dSYM\Contents\Info.plist')"
			Files="$(AppBundleDir).dSYM\Contents\Info.plist"
		/>
	</Target>

	<Target Name="_CodesignVerify" Condition="'$(ComputedPlatform)' == 'iPhone' Or '$(CodesignEntitlements)' != ''" DependsOnTargets="_CodesignAppBundle">
		<CodesignVerify
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(CodesignExe)"
			ToolPath="$(CodesignPath)"
			CodesignAllocate="$(_CodesignAllocate)"
			Resource="$(AppBundleDir)"
		>
		</CodesignVerify>
	</Target>

	<Target Name="_CoreCreateIpa" Condition="'$(BuildIpa)' == 'true'" DependsOnTargets="$(Codesign)">
		<MakeDir SessionId="$(BuildSessionId)" Condition="'$(MtouchTargetsEnabled)'" Directories="$(IntermediateOutputPath)ipa\Payload" />

		<PropertyGroup>
			<_IpaAppBundleDir>$(IntermediateOutputPath)ipa\Payload\$(_AppBundleName).app</_IpaAppBundleDir>
		</PropertyGroup>

		<!-- Clone the compiled app bundle into the IPA's Payload directory... -->
		<Ditto
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(DittoExe)"
			ToolPath="$(DittoPath)"
			Source="$(AppBundleDir)"
			Destination="$(_IpaAppBundleDir)"
		/>

		<FindWatchAppBundle
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '@(_ResolvedAppExtensionReferences)' != ''"
			AppExtensionReferences="@(_ResolvedAppExtensionReferences)"
			>
			<Output TaskParameter="WatchAppBundle" PropertyName="_WatchAppBundle"/>
		</FindWatchAppBundle>

		<Copy
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '$(_WatchAppBundle)' != '' And Exists ('$(_WatchAppBundle)\_WatchKitStub\WK')"
			SourceFiles="$(_WatchAppBundle)\_WatchKitStub\WK"
			DestinationFolder="$(IntermediateOutputPath)ipa\WatchKitSupport"
		/>

		<CollectITunesSourceFiles
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			OutputPath="$(OutputPath)"
			>
			<Output TaskParameter="ITunesSourceFiles" PropertyName="_ITunesSourceFile"/>
		</CollectITunesSourceFiles>

		<Copy
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '@(_ITunesSourceFile)' != ''"
			SourceFiles="@(_ITunesSourceFile)"
			DestinationFolder="$(IntermediateOutputPath)ipa"
		/>

		<ItemGroup>
			<_IpaPackageSource Include="$(IntermediateOutputPath)ipa\Payload" />
			<_IpaPackageSource Include="$(IntermediateOutputPath)ipa\WatchKitSupport" Condition="Exists ('$(IntermediateOutputPath)ipa\WatchKitSupport\WK')" />
			<_IpaPackageSource Include="$(IntermediateOutputPath)ipa\iTunesMetadata.plist" Condition="'$(IpaIncludeArtwork)' == 'true' And Exists ('$(IntermediateOutputPath)ipa\iTunesMetadata.plist')" />
			<_IpaPackageSource Include="$(IntermediateOutputPath)ipa\iTunesArtwork@2x" Condition="'$(IpaIncludeArtwork)' == 'true' And Exists ('$(IntermediateOutputPath)ipa\iTunesArtwork@2x')" />
			<_IpaPackageSource Include="$(IntermediateOutputPath)ipa\iTunesArtwork" Condition="'$(IpaIncludeArtwork)' == 'true' And Exists ('$(IntermediateOutputPath)ipa\iTunesArtwork')" />
		</ItemGroup>

		<PropertyGroup>
			<IpaPackageName Condition="'$(IpaPackageName)' != '' And !$(IpaPackageName.EndsWith ('.ipa', StringComparison.OrdinalIgnoreCase))">$(IpaPackageName).ipa</IpaPackageName>
			<IpaPackageName Condition="'$(IpaPackageName)' == '' And '$(_BundleVersion)' != ''">$(_AppBundleName)-$(_BundleVersion).ipa</IpaPackageName>
			<IpaPackageName Condition="'$(IpaPackageName)' == ''">$(_AppBundleName).ipa</IpaPackageName>
		</PropertyGroup>

		<Zip
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			ToolExe="$(ZipExe)"
			ToolPath="$(ZipPath)"
			Recursive="true"
			Symlinks="true"
			Sources="@(_IpaPackageSource)"
			OutputFile="$(OutputPath)$(IpaPackageName)"
			WorkingDirectory="$(IntermediateOutputPath)ipa"
		/>
	</Target>

	<Target Name="_CoreArchive" Condition="'$(ArchiveOnBuild)' == 'true'" DependsOnTargets="$(Codesign)">
		<CollectITunesSourceFiles
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)' And '@(_ITunesSourceFile)' == ''"
			OutputPath="$(OutputPath)"
			>
			<Output TaskParameter="ITunesSourceFiles" PropertyName="_ITunesSourceFile"/>
		</CollectITunesSourceFiles>

		<Archive
			SessionId="$(BuildSessionId)"
			Condition="'$(MtouchTargetsEnabled)'"
			AppBundleDir="$(AppBundleDir)"
			AppExtensionReferences="@(_ResolvedAppExtensionReferences)"
			ITunesSourceFiles="@(_ITunesSourceFile)"
			OutputPath="$(OutputPath)"
			ProjectName="$(MSBuildProjectName)"
			SolutionPath="$(SolutionPath)"
			SigningKey="$(_CodeSigningKey)"
			>
		</Archive>
	</Target>

	<Import Project="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).After.targets"
			Condition="Exists('$(MSBuildThisFileDirectory)$(MSBuildThisFileName).After.targets')"/>

</Project>
